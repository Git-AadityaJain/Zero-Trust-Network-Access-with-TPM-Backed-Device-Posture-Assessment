services:
  postgres:
    image: postgres:14
    container_name: ztna-db
    environment:
      POSTGRES_DB: ztna
      POSTGRES_USER: ztnauser
      POSTGRES_PASSWORD: supersecret
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ztnauser -d ztna"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ztna-network

  keycloak:
    image: quay.io/keycloak/keycloak:24.0.1
    container_name: ztna-keycloak
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=adminsecure123
      - KC_DB=postgres
      - KC_DB_URL_HOST=keycloak-db
      - KC_DB_URL_DATABASE=keycloak
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=keycloakpass
      - KC_HOSTNAME_STRICT=false
      - KC_HOSTNAME_STRICT_HTTPS=false
      - KC_HTTP_ENABLED=true
      - KC_HEALTH_ENABLED=true
      - KC_PROXY=edge
      - KC_PROXY_ADDRESS_FORWARDING=true
    ports:
      - "8080:8080"
    command: start-dev --import-realm
    volumes:
      - keycloak_data:/opt/keycloak/data
      - ../realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    depends_on:
      keycloak-db:
        condition: service_healthy
    networks:
      - ztna-network

  keycloak-db:
    image: postgres:14
    container_name: ztna-keycloak-db
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloakpass
    volumes:
      - keycloak_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ztna-network

  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: ztna-backend
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_started
    ports:
      - "8000:8000"
    volumes:
      - ../backend:/app
    env_file:
      - ../backend/.env
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=ztna
      - POSTGRES_USER=ztnauser
      - POSTGRES_PASSWORD=supersecret
      - OIDC_ISSUER=http://keycloak:8080/realms/master
      - OIDC_JWKS_URI=http://keycloak:8080/realms/master/protocol/openid-connect/certs
      - OIDC_CLIENT_ID=ZTNA-Platform-realm
      # OIDC_CLIENT_SECRET is loaded from .env file via env_file directive above
      - CORS_ORIGIN=${EXTERNAL_CORS_ORIGINS:-http://localhost:3000}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - ztna-network

  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: ztna-frontend
    ports:
      - "3000:3000"
    volumes:
      - ../frontend:/app
      - /app/node_modules
    environment:
      - REACT_APP_API_URL=${EXTERNAL_FRONTEND_URL:-http://localhost}/api
      - REACT_APP_KEYCLOAK_URL=${EXTERNAL_KEYCLOAK_URL:-http://localhost:8080}
      - REACT_APP_KEYCLOAK_REALM=master
      - REACT_APP_KEYCLOAK_CLIENT_ID=admin-frontend
      - CHOKIDAR_USEPOLLING=true
    depends_on:
      - backend
    networks:
      - ztna-network

  nginx:
    image: nginx:alpine
    container_name: ztna-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend
      - backend
      - keycloak
    networks:
      - ztna-network

volumes:
  pgdata:
  keycloak_data:
  keycloak_db_data:

networks:
  ztna-network:
    driver: bridge
