upstream backend {
    server backend:8000;
}

upstream frontend {
    server frontend:3000;
}

upstream keycloak {
    server keycloak:8080;
}

server {
    listen 80;
    server_name localhost;

    # Redirect HTTP to HTTPS (optional, comment out for development)
    # return 301 https://$server_name$request_uri;

    # For development, serve HTTP directly
    location / {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    location /api {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS is handled entirely by the backend's CORSMiddleware
        # Do NOT add CORS headers here to avoid duplicate headers
        # The backend will handle both preflight (OPTIONS) and actual requests
    }

    # Protected resources - requires JWT token validation
    # This route is for the demo: only enrolled users with DPA can access
    location /api/resources/ {
        # First, validate JWT token by calling backend verification endpoint
        # If token is missing or invalid, return 401
        set $token_valid 0;
        set $token "";
        
        # Extract token from Authorization header
        if ($http_authorization ~* "^Bearer\s+(.+)$") {
            set $token $1;
        }
        
        # Validate token via backend (using auth_request would be better, but requires auth_request module)
        # For now, we'll pass the token to backend and let it validate
        # The backend /api/resources/ endpoints will validate the token
        
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # Pass Authorization header to backend for validation
        proxy_set_header Authorization $http_authorization;
        
        # CORS is handled by backend
    }

    # Keycloak resources (admin console loads from /resources/...)
    # Route these to Keycloak without /auth prefix
    location /resources/ {
        proxy_pass http://keycloak/resources/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        
        # Fix HTTP URLs in JavaScript files - critical for CSP compliance
        # Keycloak's JS files contain hardcoded HTTP URLs that need to be HTTPS
        sub_filter 'http://' 'https://';
        sub_filter_once off;
        sub_filter_types text/javascript application/javascript application/x-javascript;
    }

    # Keycloak realms (login forms POST to /realms/...)
    # Route these to Keycloak and rewrite redirects to include /auth prefix
    location /realms/ {
        proxy_pass http://keycloak/realms/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        
        # Rewrite redirect Location headers to include /auth prefix
        proxy_redirect http://$host/realms/ /auth/realms/;
        proxy_redirect https://$host/realms/ /auth/realms/;
        
        # Rewrite form action URLs in HTML to include /auth prefix
        sub_filter 'action="/realms/' 'action="/auth/realms/';
        sub_filter "action='/realms/" "action='/auth/realms/";
        sub_filter_once off;
        sub_filter_types text/html;
    }

    # Keycloak admin console (redirects from Keycloak may go to /admin/...)
    # Route these to Keycloak and rewrite redirects to include /auth prefix
    location /admin/ {
        proxy_pass http://keycloak/admin/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        
        # Rewrite redirect Location headers to include /auth prefix
        proxy_redirect http://$host/admin/ /auth/admin/;
        proxy_redirect https://$host/admin/ /auth/admin/;
    }

    # Keycloak well-known endpoint - needs special handling to rewrite URLs
    location ~ ^/auth/realms/(.+)/\.well-known/openid-configuration$ {
        proxy_pass http://keycloak/realms/$1/.well-known/openid-configuration;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # Force HTTPS since requests come through ngrok with HTTPS
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        
        # Rewrite redirect Location headers - but be careful not to double-add /auth
        # Only rewrite root redirects, not paths that already have /auth
        proxy_redirect http://$host/ https://$host/auth/;
        proxy_redirect https://$host/ https://$host/auth/;
        
        # Rewrite URLs in JSON response: add /auth before /realms and force HTTPS
        # This ensures OIDC discovery URLs work through the proxy
        # Keycloak returns: "http://domain.com/realms/master/protocol/..."
        # We need: "https://domain.com/auth/realms/master/protocol/..."
        # First convert HTTP to HTTPS, then add /auth prefix
        sub_filter '"http://' '"https://';
        sub_filter '/realms/' '/auth/realms/';
        sub_filter_once off;
        sub_filter_types application/json;
    }
    
    # Keycloak - strip /auth prefix when forwarding (general case)
    location /auth/ {
        proxy_pass http://keycloak/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # Force HTTPS since requests come through ngrok with HTTPS
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Prefix /auth;
        
        # Rewrite redirect Location headers to include /auth prefix and force HTTPS
        # This fixes Keycloak redirects (e.g., /admin -> /auth/admin)
        # Handle various redirect patterns
        proxy_redirect http://$host/ https://$host/auth/;
        proxy_redirect https://$host/ https://$host/auth/;
        proxy_redirect http://$host/admin/ https://$host/auth/admin/;
        proxy_redirect https://$host/admin/ https://$host/auth/admin/;
        proxy_redirect http://$host/realms/ https://$host/auth/realms/;
        proxy_redirect https://$host/realms/ https://$host/auth/realms/;
        
        # Rewrite URLs in response bodies (for HTML/JS that might contain URLs)
        # NOTE: Do NOT include application/json here - the well-known endpoint handles that
        # NOTE: Be careful not to break Keycloak admin console - only rewrite specific patterns
        # Don't rewrite /resources/ or /realms/ as those are handled by specific location blocks
        sub_filter 'href="/admin' 'href="/auth/admin';
        sub_filter "href='/admin" "href='/auth/admin";
        sub_filter 'href="/realms' 'href="/auth/realms';
        sub_filter "href='/realms" "href='/auth/realms";
        # Fix HTTP URLs in JavaScript - critical for CSP compliance
        # Replace http:// with https:// for ngrok domains (pattern matching)
        # This fixes hardcoded HTTP URLs in Keycloak's JavaScript
        sub_filter 'http://' 'https://';
        sub_filter_once off;
        sub_filter_types text/html text/javascript application/javascript application/x-javascript;
    }
    
    # Handle /auth (without trailing slash) - redirect to /auth/
    location = /auth {
        return 301 /auth/;
    }

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}

# HTTPS server (uncomment and configure for production)
# server {
#     listen 443 ssl http2;
#     server_name localhost;
#
#     ssl_certificate /etc/nginx/ssl/cert.pem;
#     ssl_certificate_key /etc/nginx/ssl/key.pem;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
#
#     location / {
#         proxy_pass http://frontend;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection 'upgrade';
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_cache_bypass $http_upgrade;
#     }
#
#     location /api {
#         proxy_pass http://backend;
#         proxy_http_version 1.1;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }

